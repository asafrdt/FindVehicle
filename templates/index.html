<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FindVehicle â€” Yad2 Monitor</title>
  <link rel="icon" href="/favicon.ico" type="image/svg+xml">
  <style>
    :root {
      --bg: #0f1117;
      --surface: #1a1d27;
      --surface2: #242838;
      --border: #2e3348;
      --text: #e4e6f0;
      --text-muted: #8b8fa8;
      --accent: #6c8cff;
      --accent-hover: #8ba4ff;
      --green: #34d399;
      --green-dim: #064e3b;
      --red: #f87171;
      --yellow: #fbbf24;
      --radius: 8px;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { height: 100%; overflow: hidden; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.5;
    }

    .shell {
      display: flex;
      flex-direction: column;
      height: 100vh;
      padding: 12px 16px;
      gap: 10px;
    }

    /* ---- Header ---- */
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 16px;
      background: var(--surface);
      border-radius: var(--radius);
      border: 1px solid var(--border);
      flex-shrink: 0;
      flex-wrap: wrap;
      gap: 8px;
    }
    header h1 { font-size: 1.05rem; font-weight: 600; white-space: nowrap; }

    .header-center {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }
    .header-stats {
      font-size: 0.72rem;
      color: var(--text-muted);
      display: flex;
      gap: 10px;
    }
    .header-stats span b { color: var(--text); font-weight: 600; }

    .countdown-text {
      font-size: 0.72rem;
      color: var(--accent);
      min-width: 100px;
      text-align: center;
    }

    .interval-group {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 0.72rem;
      color: var(--text-muted);
    }
    .interval-group input {
      width: 36px;
      padding: 3px 4px;
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 4px;
      color: var(--text);
      font-size: 0.72rem;
      text-align: center;
      outline: none;
    }
    .interval-group input:focus { border-color: var(--accent); }

    .header-right {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .status-dot {
      width: 9px; height: 9px; border-radius: 50%;
      background: var(--red); transition: background 0.3s;
    }
    .status-dot.running {
      background: var(--green);
      box-shadow: 0 0 6px rgba(52,211,153,0.5);
    }

    .btn {
      padding: 6px 16px; border: none; border-radius: 5px;
      font-size: 0.8rem; font-weight: 500; cursor: pointer;
      transition: background 0.2s, opacity 0.2s;
    }
    .btn:disabled { opacity: 0.45; cursor: not-allowed; }

    .btn-toggle {
      min-width: 70px;
      text-align: center;
    }
    .btn-toggle.stopped { background: var(--green); color: #111; }
    .btn-toggle.stopped:hover { background: #4ade80; }
    .btn-toggle.running { background: var(--red); color: #111; }
    .btn-toggle.running:hover { background: #fca5a5; }

    .btn-sm {
      padding: 3px 10px;
      font-size: 0.72rem;
      border-radius: 4px;
      background: var(--surface2);
      border: 1px solid var(--border);
      color: var(--text-muted);
      cursor: pointer;
    }
    .btn-sm:hover { color: var(--text); border-color: var(--accent); }
    .btn-sm.danger:hover { border-color: var(--red); color: var(--red); }

    /* ---- CAPTCHA banner ---- */
    .captcha-banner {
      display: none;
      background: rgba(248,113,113,0.15);
      border: 1px solid var(--red);
      border-radius: var(--radius);
      padding: 8px 16px;
      color: var(--red);
      font-size: 0.82rem;
      font-weight: 600;
      text-align: center;
      flex-shrink: 0;
    }
    .captcha-banner.visible { display: block; }

    /* ---- Two-column body ---- */
    .main { display: flex; gap: 12px; flex: 1; min-height: 0; }

    .col-params {
      width: 340px; flex-shrink: 0;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .col-right {
      flex: 1; min-width: 0;
      display: flex; flex-direction: column;
    }

    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 14px;
    }

    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 8px;
    }

    .card h2 {
      font-size: 0.85rem; font-weight: 600;
      color: var(--accent);
    }

    .card-actions { display: flex; gap: 6px; align-items: center; }

    /* ---- Form fields ---- */
    .field { margin-bottom: 8px; }
    .field label {
      display: block; font-size: 0.75rem;
      color: var(--text-muted); margin-bottom: 2px;
    }
    .field input[type="number"],
    .field input[type="text"] {
      width: 100%; padding: 6px 8px;
      background: var(--surface2); border: 1px solid var(--border);
      border-radius: 5px; color: var(--text); font-size: 0.82rem;
      outline: none; transition: border-color 0.2s;
    }
    .field input:focus { border-color: var(--accent); }
    .field select {
      width: 100%; padding: 6px 8px;
      background: var(--surface2); border: 1px solid var(--border);
      border-radius: 5px; color: var(--text); font-size: 0.82rem;
      outline: none;
    }

    .range-row { display: flex; align-items: center; gap: 6px; }
    .range-row input { flex: 1; }
    .range-sep { color: var(--text-muted); font-size: 0.82rem; flex-shrink: 0; }

    /* ---- Advanced collapsible ---- */
    .advanced-toggle {
      display: flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      font-size: 0.75rem;
      color: var(--text-muted);
      padding: 4px 0;
      user-select: none;
      border: none;
      background: none;
      width: 100%;
      text-align: right;
    }
    .advanced-toggle:hover { color: var(--text); }
    .advanced-arrow {
      display: inline-block;
      transition: transform 0.2s;
      font-size: 0.65rem;
    }
    .advanced-arrow.open { transform: rotate(90deg); }
    .advanced-body {
      display: none;
      padding-top: 6px;
    }
    .advanced-body.open { display: block; }

    .checkbox-group { display: flex; gap: 12px; flex-wrap: wrap; }
    .checkbox-item {
      display: flex; align-items: center; gap: 5px;
      cursor: pointer; font-size: 0.78rem;
    }
    .checkbox-item input[type="checkbox"] {
      width: 14px; height: 14px; accent-color: var(--accent); cursor: pointer;
    }

    /* ---- Profiles card ---- */
    .profiles-row {
      display: flex; gap: 6px; align-items: center; margin-bottom: 8px;
    }
    .profiles-row select { flex: 1; }
    .profiles-row input[type="text"] {
      flex: 1; padding: 5px 8px;
      background: var(--surface2); border: 1px solid var(--border);
      border-radius: 5px; color: var(--text); font-size: 0.78rem;
      outline: none;
    }

    /* ---- Multi-select dropdown ---- */
    .multi-select { position: relative; }
    .ms-trigger {
      width: 100%;
      min-height: 32px;
      padding: 4px 8px;
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 5px;
      color: var(--text);
      font-size: 0.82rem;
      cursor: pointer;
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      align-items: center;
      transition: border-color 0.2s;
      text-align: right;
    }
    .ms-trigger:hover, .ms-trigger.open { border-color: var(--accent); }
    .ms-trigger .ms-placeholder { color: var(--text-muted); font-size: 0.78rem; }
    .ms-tag {
      display: inline-flex; align-items: center; gap: 3px;
      background: var(--accent); color: #fff;
      padding: 1px 7px; border-radius: 3px;
      font-size: 0.7rem; white-space: nowrap;
      max-width: 140px; overflow: hidden; text-overflow: ellipsis;
    }
    .ms-tag-x {
      cursor: pointer; font-weight: 700; margin-right: 2px;
      font-size: 0.75rem; line-height: 1;
    }
    .ms-tag-x:hover { color: var(--red); }
    .ms-dropdown {
      display: none; position: absolute; top: 100%; right: 0; left: 0;
      z-index: 50; background: var(--surface);
      border: 1px solid var(--accent);
      border-radius: 0 0 5px 5px;
      max-height: 220px; overflow: hidden; flex-direction: column;
    }
    .ms-dropdown.open { display: flex; }
    .ms-search {
      width: 100%; padding: 6px 8px;
      background: var(--surface2); border: none;
      border-bottom: 1px solid var(--border);
      color: var(--text); font-size: 0.78rem; outline: none;
    }
    .ms-list { overflow-y: auto; flex: 1; padding: 4px 0; }
    .ms-item {
      display: flex; align-items: center; gap: 6px;
      padding: 4px 10px; cursor: pointer; font-size: 0.78rem;
      transition: background 0.15s;
    }
    .ms-item:hover { background: var(--surface2); }
    .ms-item input[type="checkbox"] {
      width: 14px; height: 14px; accent-color: var(--accent);
      cursor: pointer; flex-shrink: 0;
    }
    .ms-item label {
      cursor: pointer; flex: 1; white-space: nowrap;
      overflow: hidden; text-overflow: ellipsis;
    }
    .ms-empty, .ms-loading {
      padding: 10px; text-align: center;
      color: var(--text-muted); font-size: 0.75rem;
    }

    /* ---- Listings panel ---- */
    .listings-card {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 0;
    }
    .listings-card h2 { color: var(--green); }

    .listings-toolbar {
      display: flex; align-items: center; gap: 8px; margin-bottom: 6px;
    }
    .listings-toolbar select {
      background: var(--surface2); border: 1px solid var(--border);
      border-radius: 4px; color: var(--text); font-size: 0.72rem;
      padding: 3px 6px; outline: none;
    }

    .listings-box {
      flex: 1; overflow-y: auto;
      display: flex; flex-direction: column; gap: 6px;
    }

    .listing-item {
      display: flex; align-items: center; gap: 10px;
      padding: 8px 10px; background: var(--green-dim);
      border: 1px solid rgba(52,211,153,0.25);
      border-radius: 6px; font-size: 0.8rem; direction: rtl;
    }

    .listing-thumb {
      width: 48px; height: 48px; border-radius: 4px;
      object-fit: cover; flex-shrink: 0; background: var(--surface2);
    }

    .listing-info {
      display: flex; gap: 14px; flex-wrap: wrap;
      align-items: center; min-width: 0; flex: 1;
    }

    .listing-tag { color: var(--text-muted); font-size: 0.72rem; white-space: nowrap; }
    .listing-tag b { color: var(--text); font-weight: 500; }

    .listing-actions { display: flex; gap: 6px; align-items: center; flex-shrink: 0; }

    .listing-link {
      color: var(--green); text-decoration: none; font-size: 0.78rem;
      font-weight: 500; border: 1px solid rgba(52,211,153,0.3);
      padding: 3px 10px; border-radius: 4px; transition: background 0.2s;
    }
    .listing-link:hover { background: rgba(52,211,153,0.15); }

    .dismiss-btn {
      background: none; border: none; color: var(--text-muted);
      cursor: pointer; font-size: 0.9rem; padding: 2px 6px;
      border-radius: 3px; transition: color 0.2s, background 0.2s;
    }
    .dismiss-btn:hover { color: var(--red); background: rgba(248,113,113,0.15); }

    .listing-time { color: var(--text-muted); font-size: 0.68rem; flex-shrink: 0; }

    .listings-empty {
      color: var(--text-muted); font-size: 0.8rem;
      text-align: center; padding: 16px 0;
    }

    /* ---- Bottom log console ---- */
    .log-console {
      flex-shrink: 0;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      display: flex;
      flex-direction: column;
      transition: height 0.2s;
    }

    .log-console-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 5px 12px;
      cursor: pointer;
      user-select: none;
      flex-shrink: 0;
    }
    .log-console-header h2 {
      font-size: 0.78rem; font-weight: 600;
      color: var(--accent); display: flex; align-items: center; gap: 6px;
    }
    .log-console-header .log-actions {
      display: flex; gap: 6px; align-items: center;
    }

    .log-toggle-arrow {
      display: inline-block; font-size: 0.6rem;
      transition: transform 0.2s;
    }
    .log-toggle-arrow.collapsed { transform: rotate(180deg); }

    .log-box {
      background: #0a0c12;
      border-top: 1px solid var(--border);
      padding: 8px 10px;
      overflow-y: auto;
      font-family: 'Courier New', monospace;
      font-size: 0.72rem;
      line-height: 1.45;
      direction: ltr;
      text-align: left;
      color: var(--text-muted);
      transition: height 0.2s;
    }
    .log-box.expanded { height: 160px; }
    .log-box.collapsed { height: 0; padding: 0 10px; overflow: hidden; }
    .log-box .log-line { white-space: pre-wrap; word-break: break-all; }
    .log-box .log-line-info { color: var(--text); }
    .log-box .log-line-warning { color: var(--yellow); }
    .log-box .log-line-error { color: var(--red); }
    .log-box .log-line-new {
      color: var(--green); font-weight: 600;
      background: rgba(52,211,153,0.08); border-radius: 2px;
    }

    /* ---- Toast ---- */
    .toast {
      position: fixed; bottom: 16px; left: 50%;
      transform: translateX(-50%) translateY(60px);
      background: var(--surface2); border: 1px solid var(--border);
      color: var(--text); padding: 8px 20px;
      border-radius: 6px; font-size: 0.8rem;
      opacity: 0; transition: transform 0.3s, opacity 0.3s; z-index: 100;
    }
    .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
  </style>
</head>
<body>
  <div class="shell">
    <!-- ---- HEADER ---- -->
    <header>
      <h1>FindVehicle</h1>
      <div class="header-center">
        <div class="header-stats">
          <span>×‘×“×™×§×•×ª: <b id="statChecks">0</b></span>
          <span>× ××¦××•: <b id="statFound">0</b></span>
        </div>
        <span class="countdown-text" id="countdown"></span>
        <div class="interval-group">
          <span>××¨×•×•×—:</span>
          <input type="number" id="intervalMin" min="0" max="60" value="0" title="×“×§×•×ª">
          <span>:</span>
          <input type="number" id="intervalSec" min="0" max="59" value="20" title="×©× ×™×•×ª">
        </div>
      </div>
      <div class="header-right">
        <span class="status-dot" id="statusDot"></span>
        <button class="btn btn-toggle stopped" id="btnToggle" onclick="toggleMonitor()">×”×¤×¢×œ</button>
      </div>
    </header>

    <div class="captcha-banner" id="captchaBanner">
      âš  CAPTCHA â€” <span id="captchaText">×××ª×™×Ÿ...</span>
    </div>

    <!-- ---- MAIN (two columns) ---- -->
    <div class="main">
      <!-- LEFT: Profiles + Parameters -->
      <div class="col-params">
        <div class="card">
          <div class="card-header"><h2>×¤×¨×•×¤×™×œ×™×</h2></div>
          <div class="profiles-row">
            <select id="profileSelect" onchange="onProfileSelect()">
              <option value="">â€” ×‘×—×¨ ×¤×¨×•×¤×™×œ â€”</option>
            </select>
            <button class="btn-sm danger" onclick="deleteProfile()">××—×§</button>
          </div>
          <div class="profiles-row">
            <input type="text" id="profileName" placeholder="×©× ×¤×¨×•×¤×™×œ ×—×“×©">
            <button class="btn-sm" onclick="saveProfile()">×©××•×¨</button>
          </div>
        </div>

        <div class="card">
          <h2>×¤×¨××˜×¨×™ ×—×™×¤×•×©</h2>
          <div class="field">
            <label>×™×¦×¨×Ÿ</label>
            <div class="multi-select" id="ms-manufacturer" data-field="manufacturer"></div>
          </div>
          <div class="field">
            <label>×“×’×</label>
            <div class="multi-select" id="ms-model" data-field="model"></div>
          </div>
          <div class="field">
            <label>×ª×ª-×“×’×</label>
            <div class="multi-select" id="ms-subModel" data-field="subModel"></div>
          </div>
          <div class="field">
            <label>×©× ×”</label>
            <div class="range-row">
              <input type="number" id="yearFrom" min="1990" max="2030">
              <span class="range-sep">â€”</span>
              <input type="number" id="yearTo" min="1990" max="2030">
            </div>
          </div>
          <div class="field">
            <label>××—×™×¨ (â‚ª)</label>
            <div class="range-row">
              <input type="number" id="priceFrom" step="1000">
              <span class="range-sep">â€”</span>
              <input type="number" id="priceTo" step="1000">
            </div>
          </div>
          <div class="field">
            <label>×§"×</label>
            <div class="range-row">
              <input type="number" id="kmFrom" step="1000">
              <span class="range-sep">â€”</span>
              <input type="number" id="kmTo" step="1000">
            </div>
          </div>
          <div class="field">
            <label>×™×“</label>
            <div class="range-row">
              <input type="number" id="handFrom" min="0" max="10">
              <span class="range-sep">â€”</span>
              <input type="number" id="handTo" min="0" max="10">
            </div>
          </div>

          <!-- Advanced section -->
          <div style="margin-top: 4px;">
            <button class="advanced-toggle" id="advancedToggle" onclick="toggleAdvanced()">
              <span class="advanced-arrow" id="advancedArrow">â–¶</span>
              <span>××ª×§×“×</span>
            </button>
            <div class="advanced-body" id="advancedBody">
              <div class="checkbox-group">
                <label class="checkbox-item"><input type="checkbox" id="priceOnly"> ××—×™×¨ ×‘×œ×‘×“</label>
                <label class="checkbox-item"><input type="checkbox" id="imgOnly"> ×ª××•× ×•×ª ×‘×œ×‘×“</label>
                <label class="checkbox-item"><input type="checkbox" id="ownerID"> ××•×›×¨ ×¤×¨×˜×™</label>
              </div>
              <div class="checkbox-group" style="margin-top: 8px;">
                <label class="checkbox-item"><input type="checkbox" id="autoStart"> ×”×¤×¢×œ×” ××•×˜×•××˜×™×ª</label>
                <label class="checkbox-item"><input type="checkbox" id="browserNotif"> ×”×ª×¨××•×ª ×“×¤×“×¤×Ÿ</label>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- RIGHT: Listings -->
      <div class="col-right">
        <div class="card listings-card">
          <div class="card-header">
            <h2>×¨×›×‘×™× ×©× ××¦××•</h2>
            <div class="card-actions">
              <button class="btn-sm" onclick="exportCsv()" title="×™×™×¦×•× CSV">ğŸ“¥ CSV</button>
              <button class="btn-sm danger" onclick="clearAllListings()">× ×§×” ×”×›×œ</button>
            </div>
          </div>
          <div class="listings-toolbar">
            <label style="font-size:0.72rem; color:var(--text-muted);">××™×•×Ÿ:</label>
            <select id="sortSelect" onchange="renderListings()">
              <option value="date-desc">×ª××¨×™×š (×—×“×© â†’ ×™×©×Ÿ)</option>
              <option value="date-asc">×ª××¨×™×š (×™×©×Ÿ â†’ ×—×“×©)</option>
              <option value="price-asc">××—×™×¨ (× ××•×š â†’ ×’×‘×•×”)</option>
              <option value="price-desc">××—×™×¨ (×’×‘×•×” â†’ × ××•×š)</option>
              <option value="year-desc">×©× ×” (×—×“×© â†’ ×™×©×Ÿ)</option>
              <option value="year-asc">×©× ×” (×™×©×Ÿ â†’ ×—×“×©)</option>
            </select>
          </div>
          <div class="listings-box" id="listingsBox">
            <div class="listings-empty">×œ× × ××¦××• ×¨×›×‘×™× ×¢×“×™×™×Ÿ</div>
          </div>
        </div>
      </div>
    </div>

    <!-- ---- BOTTOM LOG CONSOLE ---- -->
    <div class="log-console" id="logConsole">
      <div class="log-console-header" onclick="toggleLogConsole()">
        <h2>
          <span class="log-toggle-arrow" id="logArrow">â–¼</span>
          ×™×•××Ÿ
        </h2>
        <div class="log-actions">
          <button class="btn-sm danger" onclick="event.stopPropagation(); clearLogs()">× ×§×” ×™×•××Ÿ</button>
        </div>
      </div>
      <div class="log-box expanded" id="logBox"></div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    /* ==== State ==== */
    let _listingsData = [];
    let _prevListingsCount = 0;
    let _nextCheckAt = null;
    let _countdownInterval = null;
    let _isRunning = false;
    let _saveDebounceTimer = null;
    let _logExpanded = true;
    let _initialLoadDone = false;

    /* ==== Helpers ==== */
    function showToast(msg, ms = 2500) {
      const el = document.getElementById('toast');
      el.textContent = msg;
      el.classList.add('show');
      setTimeout(() => el.classList.remove('show'), ms);
    }

    function parseRange(val) {
      if (!val) return ['', ''];
      const parts = val.split('-');
      if (parts.length === 3 && parts[0] === '') return ['-1', parts[2]];
      if (parts.length === 2) return [parts[0], parts[1]];
      return [val, val];
    }

    function toRange(fromVal, toVal) {
      const f = fromVal === '' ? '-1' : fromVal;
      const t = toVal === '' ? '-1' : toVal;
      return `${f}-${t}`;
    }

    function escapeHtml(s) {
      const d = document.createElement('div');
      d.textContent = s;
      return d.innerHTML;
    }

    function fmtPrice(p) {
      if (!p && p !== 0) return '?';
      return Number(p).toLocaleString('he-IL') + ' â‚ª';
    }

    function fmtKm(k) {
      if (!k && k !== 0) return '?';
      return Number(k).toLocaleString('he-IL') + " ×§\"×";
    }

    function getIntervalSeconds() {
      const m = parseInt(document.getElementById('intervalMin').value) || 0;
      const s = parseInt(document.getElementById('intervalSec').value) || 0;
      return Math.max(5, m * 60 + s);
    }

    function setIntervalFields(totalSeconds) {
      document.getElementById('intervalMin').value = Math.floor(totalSeconds / 60);
      document.getElementById('intervalSec').value = totalSeconds % 60;
    }

    function fmtCountdown(totalSeconds) {
      const m = Math.floor(totalSeconds / 60);
      const s = totalSeconds % 60;
      return `${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
    }

    /* ==== Advanced toggle ==== */
    function toggleAdvanced() {
      const body = document.getElementById('advancedBody');
      const arrow = document.getElementById('advancedArrow');
      const isOpen = body.classList.toggle('open');
      arrow.classList.toggle('open', isOpen);
    }

    /* ==== Log console toggle ==== */
    function toggleLogConsole() {
      _logExpanded = !_logExpanded;
      const box = document.getElementById('logBox');
      const arrow = document.getElementById('logArrow');
      box.classList.toggle('expanded', _logExpanded);
      box.classList.toggle('collapsed', !_logExpanded);
      arrow.classList.toggle('collapsed', !_logExpanded);
    }

    /* ==================================================================
       Multi-Select Component
       ================================================================== */
    const _msInstances = {};

    function msInit(containerId, placeholder) {
      const container = document.getElementById(containerId);
      const field = container.dataset.field;
      const state = {
        field, options: [], selected: new Map(),
        isOpen: false, container, placeholder,
      };

      container.innerHTML = `
        <div class="ms-trigger" tabindex="0">
          <span class="ms-placeholder">${escapeHtml(placeholder)}</span>
        </div>
        <div class="ms-dropdown">
          <input class="ms-search" type="text" placeholder="×—×™×¤×•×©...">
          <div class="ms-list"></div>
        </div>`;

      state.trigger = container.querySelector('.ms-trigger');
      state.dropdown = container.querySelector('.ms-dropdown');
      state.searchInput = container.querySelector('.ms-search');
      state.listEl = container.querySelector('.ms-list');

      state.trigger.addEventListener('click', (e) => {
        if (e.target.closest('.ms-tag-x')) return;
        msToggle(state);
      });
      state.searchInput.addEventListener('input', () => msRenderList(state));

      _msInstances[containerId] = state;
      return state;
    }

    function msToggle(state) {
      state.isOpen = !state.isOpen;
      state.dropdown.classList.toggle('open', state.isOpen);
      state.trigger.classList.toggle('open', state.isOpen);
      if (state.isOpen) {
        state.searchInput.value = '';
        msRenderList(state);
        state.searchInput.focus();
      }
    }

    function msClose(state) {
      state.isOpen = false;
      state.dropdown.classList.remove('open');
      state.trigger.classList.remove('open');
    }

    function msSetOptions(state, options) {
      state.options = options;
      msRenderList(state);
      msRenderTrigger(state);
    }

    function msSetLoading(state) {
      state.listEl.innerHTML = '<div class="ms-loading">×˜×•×¢×Ÿ...</div>';
    }

    function msGetSelectedValues(state) { return Array.from(state.selected.keys()); }
    function msGetSelectedCSV(state) { return msGetSelectedValues(state).join(','); }

    function msSetSelectedByValues(state, values) {
      state.selected.clear();
      for (const v of values) {
        const opt = state.options.find(o => o.value === v);
        if (opt) state.selected.set(v, opt.text);
      }
      msRenderTrigger(state);
      msRenderList(state);
    }

    function msRenderTrigger(state) {
      if (state.selected.size === 0) {
        state.trigger.innerHTML = `<span class="ms-placeholder">${escapeHtml(state.placeholder)}</span>`;
        return;
      }
      let html = '';
      for (const [val, text] of state.selected) {
        html += `<span class="ms-tag" title="${escapeHtml(text)}">${escapeHtml(text)}<span class="ms-tag-x" data-val="${escapeHtml(val)}">Ã—</span></span>`;
      }
      state.trigger.innerHTML = html;
      state.trigger.querySelectorAll('.ms-tag-x').forEach(el => {
        el.addEventListener('click', (e) => {
          e.stopPropagation();
          state.selected.delete(el.dataset.val);
          msRenderTrigger(state);
          msRenderList(state);
          onMultiSelectChange(state.field);
        });
      });
    }

    function msRenderList(state) {
      const query = (state.searchInput?.value || '').trim().toLowerCase();
      const filtered = query
        ? state.options.filter(o => o.text.toLowerCase().includes(query) || o.value.includes(query))
        : state.options;

      if (filtered.length === 0) {
        state.listEl.innerHTML = state.options.length === 0
          ? '<div class="ms-empty">××™×Ÿ ××¤×©×¨×•×™×•×ª</div>'
          : '<div class="ms-empty">××™×Ÿ ×ª×•×¦××•×ª</div>';
        return;
      }

      state.listEl.innerHTML = filtered.map(o => {
        const checked = state.selected.has(o.value) ? 'checked' : '';
        return `<div class="ms-item" data-val="${escapeHtml(o.value)}"><input type="checkbox" ${checked}><label>${escapeHtml(o.text)}</label></div>`;
      }).join('');

      state.listEl.querySelectorAll('.ms-item').forEach(item => {
        item.addEventListener('click', () => {
          const val = item.dataset.val;
          const opt = state.options.find(o => o.value === val);
          if (!opt) return;
          if (state.selected.has(val)) state.selected.delete(val);
          else state.selected.set(val, opt.text);
          msRenderTrigger(state);
          msRenderList(state);
          onMultiSelectChange(state.field);
        });
      });
    }

    document.addEventListener('click', (e) => {
      for (const id in _msInstances) {
        const st = _msInstances[id];
        if (st.isOpen && !st.container.contains(e.target)) msClose(st);
      }
    });

    /* ==================================================================
       Cascading fetch logic
       ================================================================== */
    async function fetchOptions(field, params) {
      const qs = new URLSearchParams({ field, ...params });
      try {
        const resp = await fetch(`/api/yad2/options?${qs}`);
        const data = await resp.json();
        return (data[field] || []).map(o => ({ value: String(o.value), text: o.text }));
      } catch (e) { console.error('fetchOptions error', e); return []; }
    }

    async function loadManufacturers(preselect) {
      const ms = _msInstances['ms-manufacturer'];
      msSetLoading(ms);
      const opts = await fetchOptions('manufacturer', {});
      msSetOptions(ms, opts);
      if (preselect) msSetSelectedByValues(ms, preselect.split(',').filter(Boolean));
    }

    async function loadModels(preselect) {
      const ms = _msInstances['ms-model'];
      const mfr = msGetSelectedCSV(_msInstances['ms-manufacturer']);
      if (!mfr) { msSetOptions(ms, []); return; }
      msSetLoading(ms);
      const opts = await fetchOptions('model', { manufacturer: mfr });
      msSetOptions(ms, opts);
      if (preselect) msSetSelectedByValues(ms, preselect.split(',').filter(Boolean));
    }

    async function loadSubModels(preselect) {
      const ms = _msInstances['ms-subModel'];
      const mfr = msGetSelectedCSV(_msInstances['ms-manufacturer']);
      const mdl = msGetSelectedCSV(_msInstances['ms-model']);
      if (!mfr || !mdl) { msSetOptions(ms, []); return; }
      msSetLoading(ms);
      const opts = await fetchOptions('subModel', { manufacturer: mfr, model: mdl });
      msSetOptions(ms, opts);
      if (preselect) msSetSelectedByValues(ms, preselect.split(',').filter(Boolean));
    }

    async function onMultiSelectChange(field) {
      if (field === 'manufacturer') {
        const modelMs = _msInstances['ms-model'];
        const subMs = _msInstances['ms-subModel'];
        modelMs.selected.clear(); subMs.selected.clear();
        msRenderTrigger(modelMs); msRenderTrigger(subMs);
        msSetOptions(subMs, []);
        await loadModels();
      } else if (field === 'model') {
        const subMs = _msInstances['ms-subModel'];
        subMs.selected.clear(); msRenderTrigger(subMs);
        await loadSubModels();
      }
      debouncedSave();
    }

    /* ==================================================================
       Auto-save with debounce
       ================================================================== */
    function debouncedSave() {
      if (!_initialLoadDone) return;
      if (_saveDebounceTimer) clearTimeout(_saveDebounceTimer);
      _saveDebounceTimer = setTimeout(() => saveParams(true), 600);
    }

    document.addEventListener('input', (e) => {
      if (e.target.closest('.col-params') || e.target.closest('.interval-group')) {
        debouncedSave();
      }
    });
    document.addEventListener('change', (e) => {
      if (e.target.closest('.col-params') || e.target.closest('.interval-group')) {
        debouncedSave();
      }
    });

    /* ==== Params ==== */
    async function loadParams() {
      try {
        const resp = await fetch('/api/params');
        const data = await resp.json();
        const p = data.params;

        await loadManufacturers(p.manufacturer);
        await loadModels(p.model);
        await loadSubModels(p.subModel);

        const [yf, yt] = parseRange(p.year);
        document.getElementById('yearFrom').value = yf;
        document.getElementById('yearTo').value = yt;
        const [pf, pt] = parseRange(p.price);
        document.getElementById('priceFrom').value = pf === '-1' ? '' : pf;
        document.getElementById('priceTo').value = pt === '-1' ? '' : pt;
        const [kf, kt] = parseRange(p.km);
        document.getElementById('kmFrom').value = kf === '-1' ? '' : kf;
        document.getElementById('kmTo').value = kt === '-1' ? '' : kt;
        const [hf, ht] = parseRange(p.hand);
        document.getElementById('handFrom').value = hf;
        document.getElementById('handTo').value = ht;
        document.getElementById('priceOnly').checked = p.priceOnly === '1';
        document.getElementById('imgOnly').checked = p.imgOnly === '1';
        document.getElementById('ownerID').checked = p.ownerID === '1';
        setIntervalFields(data.checkInterval);
        document.getElementById('autoStart').checked = !!data.autoStart;

        _initialLoadDone = true;

        if (data.autoStart && !_isRunning) {
          toggleMonitor();
        }
      } catch (e) { console.error('Failed to load params', e); }
    }

    async function saveParams(silent) {
      const params = {
        manufacturer: msGetSelectedCSV(_msInstances['ms-manufacturer']),
        model: msGetSelectedCSV(_msInstances['ms-model']),
        subModel: msGetSelectedCSV(_msInstances['ms-subModel']),
        year: toRange(document.getElementById('yearFrom').value, document.getElementById('yearTo').value),
        price: toRange(document.getElementById('priceFrom').value || '-1', document.getElementById('priceTo').value || '-1'),
        km: toRange(document.getElementById('kmFrom').value || '-1', document.getElementById('kmTo').value || '-1'),
        hand: toRange(document.getElementById('handFrom').value, document.getElementById('handTo').value),
        priceOnly: document.getElementById('priceOnly').checked ? '1' : '0',
        imgOnly: document.getElementById('imgOnly').checked ? '1' : '0',
        ownerID: document.getElementById('ownerID').checked ? '1' : '0',
      };
      const checkInterval = getIntervalSeconds();
      const autoStart = document.getElementById('autoStart').checked;
      try {
        const resp = await fetch('/api/params', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ params, checkInterval, autoStart }),
        });
        const data = await resp.json();
        if (!silent && data.ok) showToast('×”×¤×¨××˜×¨×™× × ×©××¨×•');
      } catch (e) { if (!silent) showToast('×©×’×™××” ×‘×©××™×¨×”'); }
    }

    /* ==== Countdown ==== */
    function startCountdownTicker() {
      if (_countdownInterval) clearInterval(_countdownInterval);
      _countdownInterval = setInterval(updateCountdown, 1000);
    }

    function updateCountdown() {
      const el = document.getElementById('countdown');
      if (!_nextCheckAt || !_isRunning) { el.textContent = ''; return; }
      const remaining = Math.max(0, Math.round((new Date(_nextCheckAt) - Date.now()) / 1000));
      el.textContent = remaining <= 0
        ? '×‘×•×“×§ ×¢×›×©×™×•...'
        : `×‘×“×™×§×” ×”×‘××” ×‘×¢×•×“ ${fmtCountdown(remaining)} ×“×§×•×ª`;
    }

    /* ==== Browser notifications + beep ==== */
    function requestNotifPermission() {
      if ('Notification' in window && Notification.permission === 'default') Notification.requestPermission();
    }

    function playBeep() {
      try {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.connect(gain); gain.connect(ctx.destination);
        osc.frequency.value = 880; gain.gain.value = 0.15;
        osc.start(); osc.stop(ctx.currentTime + 0.15);
      } catch (e) { /* ignore */ }
    }

    function notifyNewListings(newItems) {
      if (!document.getElementById('browserNotif').checked) return;
      playBeep();
      if ('Notification' in window && Notification.permission === 'granted') {
        const first = newItems[0] || {};
        new Notification('×¨×›×‘ ×—×“×©!', { body: `${fmtPrice(first.price)} Â· ${first.area || ''}`, icon: '/favicon.ico' });
      }
    }

    /* ==== Monitor control ==== */
    async function pollStatus() {
      try {
        const resp = await fetch('/api/monitor/status');
        const data = await resp.json();
        _isRunning = data.running;

        const dot = document.getElementById('statusDot');
        const btn = document.getElementById('btnToggle');
        dot.classList.toggle('running', _isRunning);
        btn.textContent = _isRunning ? '×¢×¦×•×¨' : '×”×¤×¢×œ';
        btn.classList.toggle('running', _isRunning);
        btn.classList.toggle('stopped', !_isRunning);

        document.getElementById('statChecks').textContent = data.checks_count || 0;
        document.getElementById('statFound').textContent = data.found_total || 0;
        _nextCheckAt = data.next_check_at;
        updateCountdown();

        const banner = document.getElementById('captchaBanner');
        if (data.captcha_active) {
          banner.classList.add('visible');
          if (data.captcha_backoff_until) {
            const until = new Date(data.captcha_backoff_until);
            document.getElementById('captchaText').textContent = `×”××ª× ×” ×¢×“ ${until.toLocaleTimeString('he-IL')}`;
          }
        } else {
          banner.classList.remove('visible');
        }
      } catch (e) { /* ignore */ }
    }

    async function toggleMonitor() {
      const btn = document.getElementById('btnToggle');
      btn.disabled = true;
      try {
        if (_isRunning) {
          const resp = await fetch('/api/monitor/stop', { method: 'POST' });
          const data = await resp.json();
          if (data.ok) showToast('×”××•× ×™×˜×•×¨ × ×¢×¦×¨');
          else showToast(data.error || '×©×’×™××”');
        } else {
          const resp = await fetch('/api/monitor/start', { method: 'POST' });
          const data = await resp.json();
          if (data.ok) showToast('×”××•× ×™×˜×•×¨ ×”×•×¤×¢×œ');
          else showToast(data.error || '×©×’×™××”');
        }
        await pollStatus();
      } catch (e) { showToast('×©×’×™××”'); }
      btn.disabled = false;
    }

    /* ==== Listings ==== */
    function sortListings(items) {
      const mode = document.getElementById('sortSelect').value;
      const sorted = [...items];
      switch (mode) {
        case 'date-desc': return sorted.reverse();
        case 'date-asc': return sorted;
        case 'price-asc': return sorted.sort((a, b) => (Number(a.price) || 0) - (Number(b.price) || 0));
        case 'price-desc': return sorted.sort((a, b) => (Number(b.price) || 0) - (Number(a.price) || 0));
        case 'year-desc': return sorted.sort((a, b) => (Number(b.year) || 0) - (Number(a.year) || 0));
        case 'year-asc': return sorted.sort((a, b) => (Number(a.year) || 0) - (Number(b.year) || 0));
        default: return sorted.reverse();
      }
    }

    function renderListings() {
      const box = document.getElementById('listingsBox');
      if (_listingsData.length === 0) {
        box.innerHTML = '<div class="listings-empty">×œ× × ××¦××• ×¨×›×‘×™× ×¢×“×™×™×Ÿ</div>';
        return;
      }
      const sorted = sortListings(_listingsData);
      box.innerHTML = sorted.map(l => {
        const link = l.link ? `<a class="listing-link" href="${escapeHtml(l.link)}" target="_blank" rel="noopener">×¤×ª×— ×‘×™×“2</a>` : '';
        const thumb = l.img ? `<img class="listing-thumb" src="${escapeHtml(l.img)}" alt="" loading="lazy" onerror="this.style.display='none'">` : '';
        return `<div class="listing-item">
          ${thumb}
          <div class="listing-info">
            <span class="listing-tag"><b>${escapeHtml(fmtPrice(l.price))}</b></span>
            <span class="listing-tag">${escapeHtml(l.year || '?')}</span>
            <span class="listing-tag">${escapeHtml(fmtKm(l.km))}</span>
            <span class="listing-tag">${escapeHtml(l.area || '')}</span>
            <span class="listing-tag">${escapeHtml(l.hand || '')}</span>
            <span class="listing-time">${escapeHtml(l.found_at || '')}</span>
          </div>
          <div class="listing-actions">
            ${link}
            <button class="dismiss-btn" onclick="dismissListing('${escapeHtml(l.token)}')" title="×”×¡×¨">âœ•</button>
          </div>
        </div>`;
      }).join('');
    }

    async function pollListings() {
      try {
        const resp = await fetch('/api/listings');
        const data = await resp.json();
        const items = data.listings || [];
        if (items.length > _prevListingsCount && _prevListingsCount > 0) {
          notifyNewListings(items.slice(_prevListingsCount));
        }
        _prevListingsCount = items.length;
        _listingsData = items;
        renderListings();
      } catch (e) { /* ignore */ }
    }

    async function dismissListing(token) {
      try {
        await fetch(`/api/listings/${token}`, { method: 'DELETE' });
        _listingsData = _listingsData.filter(l => l.token !== token);
        _prevListingsCount = _listingsData.length;
        renderListings();
      } catch (e) { showToast('×©×’×™××” ×‘×”×¡×¨×”'); }
    }

    async function clearAllListings() {
      if (!confirm('×œ××—×•×§ ××ª ×›×œ ×”×¨×›×‘×™× ×•×œ××¤×¡ ××ª ×”×”×™×¡×˜×•×¨×™×”? ×¨×›×‘×™× ×§×™×™××™× ×™×•×¤×™×¢×• ×©×•×‘ ×›×—×“×©×™×.')) return;
      try {
        await fetch('/api/listings', { method: 'DELETE' });
        _listingsData = [];
        _prevListingsCount = 0;
        renderListings();
        showToast('×”×¨×©×™××” ×•×”×”×™×¡×˜×•×¨×™×” ××•×¤×¡×•');
      } catch (e) { showToast('×©×’×™××”'); }
    }

    function exportCsv() { window.open('/api/listings/export', '_blank'); }

    /* ==== Profiles ==== */
    async function loadProfiles() {
      try {
        const resp = await fetch('/api/profiles');
        const profiles = await resp.json();
        const sel = document.getElementById('profileSelect');
        const current = sel.value;
        sel.innerHTML = '<option value="">â€” ×‘×—×¨ ×¤×¨×•×¤×™×œ â€”</option>';
        for (const name of Object.keys(profiles)) {
          const opt = document.createElement('option');
          opt.value = name; opt.textContent = name;
          sel.appendChild(opt);
        }
        if (current && profiles[current]) sel.value = current;
      } catch (e) { /* ignore */ }
    }

    async function saveProfile() {
      const name = document.getElementById('profileName').value.trim();
      if (!name) { showToast('×”×–×Ÿ ×©× ×¤×¨×•×¤×™×œ'); return; }
      await saveParams(true);
      try {
        await fetch('/api/profiles', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name }),
        });
        showToast(`×¤×¨×•×¤×™×œ "${name}" × ×©××¨`);
        document.getElementById('profileName').value = '';
        loadProfiles();
      } catch (e) { showToast('×©×’×™××” ×‘×©××™×¨×ª ×¤×¨×•×¤×™×œ'); }
    }

    async function onProfileSelect() {
      const name = document.getElementById('profileSelect').value;
      if (!name) return;
      try {
        const resp = await fetch(`/api/profiles/${encodeURIComponent(name)}/load`, { method: 'POST' });
        const data = await resp.json();
        if (data.ok) {
          showToast(`×¤×¨×•×¤×™×œ "${name}" × ×˜×¢×Ÿ`);
          _initialLoadDone = false;
          await loadParams();
        } else { showToast(data.error || '×©×’×™××”'); }
      } catch (e) { showToast('×©×’×™××” ×‘×˜×¢×™× ×ª ×¤×¨×•×¤×™×œ'); }
    }

    async function deleteProfile() {
      const name = document.getElementById('profileSelect').value;
      if (!name) { showToast('×‘×—×¨ ×¤×¨×•×¤×™×œ'); return; }
      if (!confirm(`×œ××—×•×§ ××ª ×”×¤×¨×•×¤×™×œ "${name}"?`)) return;
      try {
        await fetch(`/api/profiles/${encodeURIComponent(name)}`, { method: 'DELETE' });
        showToast(`×¤×¨×•×¤×™×œ "${name}" × ××—×§`);
        loadProfiles();
      } catch (e) { showToast('×©×’×™××” ×‘××—×™×§×ª ×¤×¨×•×¤×™×œ'); }
    }

    /* ==== Logs ==== */
    async function clearLogs() {
      try {
        await fetch('/api/logs', { method: 'DELETE' });
        document.getElementById('logBox').innerHTML = '';
        showToast('×”×™×•××Ÿ × ×•×§×”');
      } catch (e) { showToast('×©×’×™××” ×‘× ×™×§×•×™ ×™×•××Ÿ'); }
    }

    async function pollLogs() {
      try {
        const resp = await fetch('/api/logs');
        const data = await resp.json();
        const box = document.getElementById('logBox');
        const wasAtBottom = box.scrollHeight - box.scrollTop - box.clientHeight < 40;
        box.innerHTML = data.lines.map(line => {
          let cls = 'log-line';
          if (line.includes('New listing:') && !line.includes('No new listing')) cls += ' log-line-new';
          else if (line.includes('| ERROR |')) cls += ' log-line-error';
          else if (line.includes('| WARNING |')) cls += ' log-line-warning';
          else if (line.includes('| INFO |')) cls += ' log-line-info';
          return `<div class="${cls}">${escapeHtml(line)}</div>`;
        }).join('');
        if (wasAtBottom) box.scrollTop = box.scrollHeight;
      } catch (e) { /* ignore */ }
    }

    /* ==== Browser notification preference ==== */
    function initNotifPreference() {
      const saved = localStorage.getItem('browserNotif');
      const cb = document.getElementById('browserNotif');
      if (saved === 'true') { cb.checked = true; requestNotifPermission(); }
      cb.addEventListener('change', () => {
        localStorage.setItem('browserNotif', cb.checked);
        if (cb.checked) requestNotifPermission();
      });
    }

    /* ==== Init ==== */
    msInit('ms-manufacturer', '×‘×—×¨ ×™×¦×¨×Ÿ...');
    msInit('ms-model', '×‘×—×¨ ×“×’×...');
    msInit('ms-subModel', '×‘×—×¨ ×ª×ª-×“×’×...');

    initNotifPreference();
    loadParams();
    loadProfiles();
    pollStatus();
    pollListings();
    pollLogs();
    startCountdownTicker();
    setInterval(pollStatus, 3000);
    setInterval(pollListings, 4000);
    setInterval(pollLogs, 4000);
  </script>
</body>
</html>
